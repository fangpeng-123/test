# Robot Palm Detect 手掌检测功能包开发文档

## 1. 概述

Robot Palm Detect 是一个基于 ROS 2 的手掌手势识别功能包，利用 MediaPipe 和 OpenCV 实现对手掌手势的实时检测和识别。该功能包可以识别多种手势，包括 OK、Return、Left、Right、Like 和 Pause 等，并将识别结果发布到指定的话题上。

## 2. 功能特性

- 实时手势识别：基于摄像头输入实时识别手掌手势
- 多手势支持：支持识别 OK、Return、Left、Right、Like、Pause 等手势
- ROS 2 集成：遵循 ROS 2 规范，提供标准的发布/订阅接口
- 模块化设计：包含手势检测节点和视频发布节点，便于扩展和维护

## 3. 系统架构

```
robot_palm_detect/
├── robot_palm_detect/
│   ├── __init__.py
│   ├── robot_palm_detect.py      # 批量图片处理脚本
│   ├── video_publisher.py        # 视频发布节点
│   └── hand_detector_node.py     # 手势检测节点
├── test/
├── package.xml
├── setup.cfg
└── setup.py
```

## 4. 依赖项

### 4.1 系统依赖
- ROS 2 (Humble)
- Python 3.8+

### 4.2 Python 包依赖
- opencv-python
- mediapipe
- numpy
- loguru
- rclpy
- sensor_msgs
- std_msgs
- cv_bridge

## 5. 安装与配置

### 5.1 环境准备
```bash
# 安装系统依赖
sudo apt update
sudo apt install python3-pip python3-opencv -y

# 安装Python包依赖
pip3 install mediapipe opencv-python loguru numpy
```

### 5.2 构建功能包
```bash
# 克隆或复制功能包到ROS 2工作空间的src目录下
cd /path/to/your/ros2/workspace
colcon build --packages-select robot_palm_detect
source install/setup.bash
```

## 6. 节点说明

### 6.1 hand_detector_node.py (手势检测节点)

#### 6.1.1 功能描述
该节点订阅 [/image_raw](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/build/robot_palm_detect/build/lib/robot_palm_detect/video_publisher.py#L12-L12) 话题获取图像数据，使用 MediaPipe 检测手部关键点，通过几何计算判断手势类型，并将识别结果发布到 [/robot_palmdetect](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/palm_detect/palmdetect.py) 话题。

#### 6.1.2 订阅话题
- [/image_raw](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/build/robot_palm_detect/build/lib/robot_palm_detect/video_publisher.py#L12-L12): sensor_msgs/Image 类型，输入图像数据

#### 6.1.3 发布话题
- [/robot_palmdetect](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/palm_detect/palmdetect.py): std_msgs/String 类型，手势识别结果

#### 6.1.4 启动命令
```bash
ros2 run robot_palm_detect hand_detector
```

### 6.2 video_publisher.py (视频发布节点)

#### 6.2.1 功能描述
该节点捕获摄像头视频流，将图像数据发布到 [/image_raw](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/build/robot_palm_detect/build/lib/robot_palm_detect/video_publisher.py#L12-L12) 话题，为手势检测节点提供图像输入。

#### 6.2.2 发布话题
- [/image_raw](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/build/robot_palm_detect/build/lib/robot_palm_detect/video_publisher.py#L12-L12): sensor_msgs/Image 类型，输出图像数据

#### 6.2.3 启动命令
```bash
ros2 run robot_palm_detect video_publisher
```

### 6.3 robot_palm_detect.py (批量图片处理脚本)

#### 6.3.1 功能描述
该脚本用于批量处理指定文件夹中的图片，识别每张图片中的手势，并将结果保存到输出文件夹中。

#### 6.3.2 使用方法
```bash
python3 robot_palm_detect.py <input_folder> <output_folder>
```

## 7. 手势识别算法

### 7.1 关键点检测
使用 MediaPipe 的 Hands 解决方案检测手部的 21 个关键点，包括：
- point0: 手腕
- point1-point4: 大拇指
- point5-point8: 食指
- point9-point12: 中指
- point13-point16: 无名指
- point17-point20: 小拇指

### 7.2 手指状态判断
通过计算关键点之间的角度判断每根手指的弯曲或伸直状态：
- 大拇指弯曲阈值: 0.25π
- 其他手指弯曲阈值: 0.5π
- 其他手指伸直阈值: 0.2π

### 7.3 手势识别规则

#### OK 手势
- 食指、中指、无名指、小拇指伸直
- 拇指和食指形成圆形

#### Return 手势
- 所有手指弯曲
- 手掌呈拳头状

#### Left 手势
- 大拇指伸直，其他手指弯曲
- 大拇指指向左侧

#### Right 手势
- 大拇指伸直，其他手指弯曲
- 大拇指指向右侧

#### Like 手势
- 大拇指伸直向上
- 其他手指弯曲

#### Pause 手势
- 所有手指伸直并并拢

## 8. 使用示例

### 8.1 启动完整手势识别系统
```bash
# 终端1: 启动视频发布节点
ros2 run robot_palm_detect video_publisher

# 终端2: 启动手势检测节点
ros2 run robot_palm_detect hand_detector

# 终端3: 监听手势识别结果
ros2 topic echo /robot_palmdetect
```

### 8.2 批量处理图片
```bash
python3 robot_palm_detect.py /path/to/input/images /path/to/output/results
```

## 9. 故障排除

### 9.1 ModuleNotFoundError
如果遇到模块未找到错误，请确保所有依赖项已正确安装：
```bash
pip3 install mediapipe opencv-python loguru
```

### 9.2 摄像头无法打开
检查摄像头设备是否正常工作：
```bash
# 检查摄像头设备
ls /dev/video*

# 测试摄像头
ffplay /dev/video0
```

### 9.3 手势识别不准确
- 确保手部完全在摄像头视野内
- 保持适当的手部距离（建议 30-50cm）
- 确保光线充足且均匀
- 调整 [min_detection_confidence](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/palm_detect/robot_palm_detect/src/robot_palm_detect/robot_palm_detect/hand_detector_node.py#L348-L348) 参数以提高检测精度

## 10. 扩展开发

### 10.1 添加新手势
1. 在 [detect_hand_state](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/palm_detect/robot_palm_detect/src/robot_palm_detect/robot_palm_detect/hand_detector_node.py#L253-L277) 函数中添加新的手势判断函数
2. 实现具体的判断逻辑
3. 在主识别流程中添加调用代码

### 10.2 调整识别参数
可以在 [hand_detector_node.py](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/palm_detect/robot_palm_detect/src/robot_palm_detect/robot_palm_detect/hand_detector_node.py) 中调整以下参数：
- 手指弯曲/伸直的阈值角度
- 手势识别的置信度阈值
- 图像处理的相关参数

## 11. 注意事项

1. 该功能包默认使用摄像头设备 /dev/video0，如需更改请修改 [video_publisher.py](file:///media/yls/1T%E7%A1%AC%E7%9B%984/code/palm_detect/robot_palm_detect/src/robot_palm_detect/robot_palm_detect/video_publisher.py) 中的摄像头索引
2. 手势识别精度受光照、背景、手势距离等因素影响，建议在光线均匀的环境下使用
3. 为了获得最佳识别效果，请正面对准摄像头，保持手部稳定